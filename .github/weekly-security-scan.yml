name: Weekly Security Scan

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build scan image
        run: |
          docker build -f Dockerfile.scan -t scan-image:latest .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'scan-image:latest'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Parse results and send to Slack
        run: |
          # Ï∑®ÏïΩÏ†ê Ïπ¥Ïö¥Ìä∏
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-results.json)
          TOTAL=$((CRITICAL + HIGH + MEDIUM))
          
          # ÎÇ†Ïßú
          SCAN_DATE=$(date +'%Y-%m-%d %H:%M UTC')
          
          # ÏÉÅÌÉú Ïù¥Î™®ÏßÄ
          if [ "$CRITICAL" -gt 0 ]; then
            STATUS="üö®"
            COLOR="#dc3545"
          elif [ "$HIGH" -gt 0 ]; then
            STATUS="‚ö†Ô∏è"
            COLOR="#ffc107"
          elif [ "$MEDIUM" -gt 0 ]; then
            STATUS="üì¢"
            COLOR="#17a2b8"
          else
            STATUS="‚úÖ"
            COLOR="#28a745"
          fi
          
          # Critical/High Ï∑®ÏïΩÏ†ê ÏÉÅÏÑ∏ Î™©Î°ù (ÏµúÎåÄ 10Í∞ú)
          VULN_DETAILS=$(jq -r '
            [.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] 
            | .[0:10] 
            | .[] 
            | "‚Ä¢ \(.Severity): \(.VulnerabilityID) - \(.PkgName) (\(.InstalledVersion) ‚Üí \(.FixedVersion // "no fix"))"
          ' trivy-results.json)
          
          # ÏÉÅÏÑ∏ Î™©Î°ùÏù¥ ÎπÑÏñ¥ÏûàÏúºÎ©¥ Î©îÏãúÏßÄ ÏÑ§Ï†ï
          if [ -z "$VULN_DETAILS" ]; then
            VULN_DETAILS="Critical/High Ï∑®ÏïΩÏ†ê ÏóÜÏùå"
          fi
          
          # Slack Î©îÏãúÏßÄ ÏÉùÏÑ±
          cat << EOF > slack-payload.json
          {
            "attachments": [
              {
                "color": "${COLOR}",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "${STATUS} Weekly Docker Image Security Scan",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Ïä§Ï∫î ÏùºÏãú:*\n${SCAN_DATE}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Ï¥ù Ï∑®ÏïΩÏ†ê:*\n${TOTAL}Í∞ú"
                      }
                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*üö® Critical:*\n${CRITICAL}Í∞ú"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*‚ö†Ô∏è High:*\n${HIGH}Í∞ú"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*üì¢ Medium:*\n${MEDIUM}Í∞ú"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*üì¶ Image:*\neclipse-temurin:21-alpine"
                      }
                    ]
                  },
                  {
                    "type": "divider"
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Critical/High Ï∑®ÏïΩÏ†ê ÏÉÅÏÑ∏:*\n\`\`\`${VULN_DETAILS}\`\`\`"
                    }
                  },
                  {
                    "type": "context",
                    "elements": [
                      {
                        "type": "mrkdwn",
                        "text": "üîó <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions ÏÉÅÏÑ∏ Î≥¥Í∏∞>"
                      }
                    ]
                  }
                ]
              }
            ]
          }
          EOF
          
          # Slack Ï†ÑÏÜ°
          curl -X POST -H 'Content-type: application/json' \
            --data @slack-payload.json \
            $SLACK_WEBHOOK_URL

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-results.json
          retention-days: 30
