name: Weekly Security Scan

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build scan image
        run: |
          docker build -f Dockerfile.scan -t scan-image:latest .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'scan-image:latest'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Parse results and send to Slack
        run: |
          # Ï∑®ÏïΩÏ†ê Ïπ¥Ïö¥Ìä∏
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-results.json)
          TOTAL=$((CRITICAL + HIGH + MEDIUM))
          
          # ÎÇ†Ïßú
          SCAN_DATE=$(date +'%Y-%m-%d %H:%M UTC')
          
          # ÏÉÅÌÉú Ïù¥Î™®ÏßÄ Î∞è ÏÉâÏÉÅ
          if [ "$CRITICAL" -gt 0 ]; then
            STATUS="üö®"
            COLOR="#dc3545"
          elif [ "$HIGH" -gt 0 ]; then
            STATUS="‚ö†Ô∏è"
            COLOR="#ffc107"
          elif [ "$MEDIUM" -gt 0 ]; then
            STATUS="üì¢"
            COLOR="#17a2b8"
          else
            STATUS="‚úÖ"
            COLOR="#28a745"
          fi
          
          # Critical/High Ï¥ù Í∞úÏàò
          TOTAL_HIGH_CRITICAL=$((CRITICAL + HIGH))
          
          # Ï∑®ÏïΩÏ†ê Î™©Î°ù ÏÉùÏÑ± ÌõÑ ÏûÑÏãú ÌååÏùºÏóê Ï†ÄÏû•
          jq -r '
            [.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")]
            | sort_by(if .Severity == "CRITICAL" then 0 else 1 end)
            | .[0:10]
            | .[]
            | "[\(.Severity)] \(.VulnerabilityID)\n  Library:   \(.PkgName)\n  Status:    \(.Status // "unknown")\n  Installed: \(.InstalledVersion)\n  Fixed:     \(.FixedVersion // "no fix")\n"
          ' trivy-results.json > vuln_list.txt
          
          # 10Í∞ú Ï¥àÍ≥º Ïãú footer Ï∂îÍ∞Ä
          if [ "$TOTAL_HIGH_CRITICAL" -gt 10 ]; then
            echo "" >> vuln_list.txt
            echo "... Ïô∏ $((TOTAL_HIGH_CRITICAL - 10))Í±¥ Îçî ÏûàÏùå" >> vuln_list.txt
          fi
          
          # ÌååÏùºÏù¥ ÎπÑÏñ¥ÏûàÏúºÎ©¥ Í∏∞Î≥∏ Î©îÏãúÏßÄ
          if [ ! -s vuln_list.txt ]; then
            echo "Critical/High Ï∑®ÏïΩÏ†ê ÏóÜÏùå ‚úÖ" > vuln_list.txt
          fi
          
          # jqÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÏïàÏ†ÑÌïòÍ≤å JSON ÏÉùÏÑ±
          jq -n \
            --arg status "$STATUS" \
            --arg color "$COLOR" \
            --arg scan_date "$SCAN_DATE" \
            --arg total "$TOTAL" \
            --arg critical "$CRITICAL" \
            --arg high "$HIGH" \
            --arg medium "$MEDIUM" \
            --arg total_hc "$TOTAL_HIGH_CRITICAL" \
            --arg vuln_list "$(cat vuln_list.txt)" \
            --arg actions_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '{
              "attachments": [
                {
                  "color": $color,
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "\($status) Weekly Docker Image Security Scan",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*üìÖ Ïä§Ï∫î ÏùºÏãú:*\n\($scan_date)"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*üìä Ï¥ù Ï∑®ÏïΩÏ†ê:*\n\($total)Í∞ú"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*üö® Critical:* \($critical)Í∞ú\n*‚ö†Ô∏è High:* \($high)Í∞ú\n*üì¢ Medium:* \($medium)Í∞ú"
                      }
                    },
                    {
                      "type": "divider"
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*üîç Critical/High Ï∑®ÏïΩÏ†ê ÏÉÅÏÑ∏ (\($total_hc)Í±¥):*"
                      }
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "```\($vuln_list)```"
                      }
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "üîó <\($actions_url)|trivy scan Î¶¨Ìè¨Ìä∏ Î≥¥Í∏∞>"
                        }
                      ]
                    }
                  ]
                }
              ]
            }' > slack-payload.json
          
          # Slack Ï†ÑÏÜ°
          curl -X POST -H 'Content-type: application/json' \
            --data @slack-payload.json \
            $SLACK_WEBHOOK_URL
          
          # ÏûÑÏãú ÌååÏùº Ï†ïÎ¶¨
          rm -f vuln_list.txt

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-results.json
          retention-days: 30
