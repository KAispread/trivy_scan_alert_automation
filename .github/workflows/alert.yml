name: Weekly Security Scan

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract base image from Dockerfile
        id: base-image
        run: |
          echo "=== Dockerfile ë‚´ìš© ==="
          cat Dockerfile.scan
          echo ""
          
          echo "=== FROM ë¼ì¸ ì¶”ì¶œ ==="
          
          # FROM ë¼ì¸ ì¶”ì¶œ (ë” ê²¬ê³ í•œ ë°©ì‹)
          FROM_LINE=$(head -1 Dockerfile.scan | tr -d '\r')
          echo "FROM line: '$FROM_LINE'"
          
          # FROM í‚¤ì›Œë“œ ì œê±°í•˜ê³  ì´ë¯¸ì§€ë§Œ ì¶”ì¶œ
          BASE_IMAGE=$(echo "$FROM_LINE" | sed 's/^FROM[[:space:]]*//' | awk '{print $1}')
          
          echo "Extracted base image: '$BASE_IMAGE'"
          
          # ì´ë¯¸ì§€ ì´ë¦„ ê²€ì¦
          if [ -z "$BASE_IMAGE" ]; then
            echo "Error: Failed to extract base image from Dockerfile"
            exit 1
          fi
          
          # ì´ë¯¸ì§€ê°€ ì‹¤ì œë¡œ pull ê°€ëŠ¥í•œì§€ í™•ì¸ (ì„ íƒì‚¬í•­)
          echo "Validating image format..."
          if [[ ! "$BASE_IMAGE" =~ ^[a-zA-Z0-9._/-]+:[a-zA-Z0-9._-]+$ ]] && [[ ! "$BASE_IMAGE" =~ ^[a-zA-Z0-9._/-]+$ ]]; then
            echo "Warning: Image format might be invalid: '$BASE_IMAGE'"
          fi
          
          echo "image=$BASE_IMAGE" >> $GITHUB_OUTPUT

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ steps.base-image.outputs.image }}'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Parse results and send to Slack
        run: |
          BASE_IMAGE="${{ steps.base-image.outputs.image }}"
          
          # ì·¨ì•½ì  ì¹´ìš´íŠ¸
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-results.json)
          TOTAL=$((CRITICAL + HIGH + MEDIUM))
          
          # ë‚ ì§œ
          SCAN_DATE=$(date +'%Y-%m-%d %H:%M UTC')
          
          # ìƒíƒœ ì´ëª¨ì§€ ë° ìƒ‰ìƒ
          if [ "$CRITICAL" -gt 0 ]; then
            STATUS="ğŸš¨"
            COLOR="#dc3545"
          elif [ "$HIGH" -gt 0 ]; then
            STATUS="âš ï¸"
            COLOR="#ffc107"
          elif [ "$MEDIUM" -gt 0 ]; then
            STATUS="ğŸ“¢"
            COLOR="#17a2b8"
          else
            STATUS="âœ…"
            COLOR="#28a745"
          fi
          
          # Critical/High ì´ ê°œìˆ˜
          TOTAL_HIGH_CRITICAL=$((CRITICAL + HIGH))
          
          # ì·¨ì•½ì  ëª©ë¡ì„ ê°œë³„ JSON ë°°ì—´ë¡œ ìƒì„± (ìµœëŒ€ 10ê°œ)
          VULN_BLOCKS=$(jq -c '
            [.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")]
            | sort_by(if .Severity == "CRITICAL" then 0 else 1 end)
            | .[0:10]
            | to_entries
            | .[]
            | {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ("*" + ((.key + 1) | tostring) + ". [" + .value.Severity + "] " + .value.VulnerabilityID + "*\nâ€¢ Library: `" + .value.PkgName + "`\nâ€¢ Status: " + (.value.Status // "unknown") + "\nâ€¢ Installed: " + .value.InstalledVersion + "\nâ€¢ Fixed: " + (.value.FixedVersion // "no fix"))
                }
              }
          ' trivy-results.json | jq -s '.')
          
          # ì·¨ì•½ì ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë¸”ë¡ ìƒì„±
          if [ "$VULN_BLOCKS" == "[]" ] || [ -z "$VULN_BLOCKS" ]; then
            VULN_BLOCKS='[{"type": "section", "text": {"type": "mrkdwn", "text": "Critical/High ì·¨ì•½ì  ì—†ìŒ âœ…"}}]'
          fi
          
          # 10ê°œ ì´ˆê³¼ ì‹œ footer ë¸”ë¡ ì¶”ê°€
          if [ "$TOTAL_HIGH_CRITICAL" -gt 10 ]; then
            FOOTER_BLOCK=', {"type": "context", "elements": [{"type": "mrkdwn", "text": "_... ì™¸ '"$((TOTAL_HIGH_CRITICAL - 10))"'ê±´ ë” ìˆìŒ_"}]}'
            VULN_BLOCKS=$(echo "$VULN_BLOCKS" | sed 's/]$/'"$FOOTER_BLOCK"']/')
          fi
          
          # ìµœì¢… JSON ìƒì„± (ì´ë¯¸ì§€ ì´ë¦„ í¬í•¨)
          cat << EOF > slack-payload.json
          {
            "attachments": [
              {
                "color": "${COLOR}",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "${STATUS} Weekly Docker Image Security Scan",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*ğŸ“… ìŠ¤ìº” ì¼ì‹œ:*\n${SCAN_DATE}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ğŸ“Š ì´ ì·¨ì•½ì :*\n${TOTAL}ê°œ"
                      }
                    ]
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*ğŸš¨ Critical:* ${CRITICAL}ê°œ\n*âš ï¸ High:* ${HIGH}ê°œ\n*ğŸ“¢ Medium:* ${MEDIUM}ê°œ"
                    }
                  },
                  {
                    "type": "context",
                    "elements": [
                      {
                        "type": "mrkdwn",
                        "text": "ğŸ“¦ *Image:* \`${BASE_IMAGE}\`"
                      }
                    ]
                  },
                  {
                    "type": "divider"
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*ğŸ” Critical/High ì·¨ì•½ì  ìƒì„¸ (${TOTAL_HIGH_CRITICAL}ê±´):*"
                    }
                  }
                ]
              }
            ]
          }
          EOF
          
          # ì·¨ì•½ì  ë¸”ë¡ë“¤ì„ attachments[0].blocks ë°°ì—´ì— ì¶”ê°€
          jq --argjson vuln_blocks "$VULN_BLOCKS" '.attachments[0].blocks += $vuln_blocks' slack-payload.json > temp.json && mv temp.json slack-payload.json
          
          # ë§í¬ ë¸”ë¡ ì¶”ê°€
          jq --arg url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '.attachments[0].blocks += [
              {"type": "divider"},
              {"type": "actions", "elements": [{"type": "button", "text": {"type": "plain_text", "text": "ğŸ“‹ trivy scan ë¦¬í¬íŠ¸ ë³´ê¸°", "emoji": true}, "url": $url, "style": "primary"}]}
            ]' slack-payload.json > temp.json && mv temp.json slack-payload.json
          
          # Slack ì „ì†¡
          curl -X POST -H 'Content-type: application/json' \
            --data @slack-payload.json \
            $SLACK_WEBHOOK_URL

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-results.json
          retention-days: 30
