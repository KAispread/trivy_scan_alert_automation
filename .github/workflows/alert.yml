name: Weekly Security Scan

on:
  schedule:
    - cron: '0 1 * * 1'
  workflow_dispatch:

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build scan image
        run: |
          docker build -f Dockerfile.scan -t scan-image:latest .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'scan-image:latest'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Parse results and send to Slack
        run: |
          # ì·¨ì•½ì  ì¹´ìš´íŠ¸
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-results.json)
          TOTAL=$((CRITICAL + HIGH + MEDIUM))
          
          # ë‚ ì§œ
          SCAN_DATE=$(date +'%Y-%m-%d %H:%M UTC')
          
          # ìƒíƒœ ì´ëª¨ì§€ ë° ìƒ‰ìƒ
          if [ "$CRITICAL" -gt 0 ]; then
            STATUS="ğŸš¨"
            COLOR="#dc3545"
          elif [ "$HIGH" -gt 0 ]; then
            STATUS="âš ï¸"
            COLOR="#ffc107"
          elif [ "$MEDIUM" -gt 0 ]; then
            STATUS="ğŸ“¢"
            COLOR="#17a2b8"
          else
            STATUS="âœ…"
            COLOR="#28a745"
          fi
          
          # Critical/High ì·¨ì•½ì  ëª©ë¡ (CVE ê¸°ì¤€ ì¤‘ë³µ ì œê±°, ìµœëŒ€ 10ê°œ, ë³´ê¸° ì¢‹ì€ í˜•ì‹)
          VULN_LIST=$(jq -r '
            [.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")]
            | group_by(.VulnerabilityID)
            | map({
                cve: .[0].VulnerabilityID,
                severity: .[0].Severity,
                pkg: .[0].PkgName,
                installed: .[0].InstalledVersion,
                fixed: (.[0].FixedVersion // "no fix")
              })
            | sort_by(.severity)
            | .[0:10]
            | to_entries
            | .[]
            | "\(.key + 1). [\(.value.severity)] \(.value.cve)\n   ğŸ“¦ \(.value.pkg): \(.value.installed) â†’ \(.value.fixed)"
          ' trivy-results.json)
          
          # ì´ CVE ê°œìˆ˜ (ì¤‘ë³µ ì œê±°)
          TOTAL_CVES=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | group_by(.VulnerabilityID) | length' trivy-results.json)
          
          # ìƒì„¸ ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ë©”ì‹œì§€ ì„¤ì •
          if [ -z "$VULN_LIST" ]; then
            VULN_LIST="Critical/High ì·¨ì•½ì  ì—†ìŒ âœ…"
            FOOTER_TEXT=""
          else
            if [ "$TOTAL_CVES" -gt 10 ]; then
              FOOTER_TEXT="\n\n_... ì™¸ $((TOTAL_CVES - 10))ê±´ ë” ìˆìŒ. GitHub Actionsì—ì„œ ì „ì²´ í™•ì¸_"
            else
              FOOTER_TEXT=""
            fi
          fi
          
          # JSON ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ (ì¤„ë°”ê¿ˆ, íŠ¹ìˆ˜ë¬¸ì)
          VULN_LIST_ESCAPED=$(echo "$VULN_LIST" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
          VULN_LIST_ESCAPED=${VULN_LIST_ESCAPED:1:-1}  # ì•ë’¤ ë”°ì˜´í‘œ ì œê±°
          
          FOOTER_ESCAPED=$(echo "$FOOTER_TEXT" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
          FOOTER_ESCAPED=${FOOTER_ESCAPED:1:-1}
          
          # Slack ë©”ì‹œì§€ ìƒì„±
          cat << EOF > slack-payload.json
          {
            "attachments": [
              {
                "color": "${COLOR}",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "${STATUS} Weekly Docker Image Security Scan",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*ğŸ“… ìŠ¤ìº” ì¼ì‹œ:*\n${SCAN_DATE}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ğŸ“Š ì´ ì·¨ì•½ì :*\n${TOTAL}ê°œ"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ğŸš¨ Critical:* ${CRITICAL}ê°œ"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*âš ï¸ High:* ${HIGH}ê°œ"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ğŸ“¢ Medium:* ${MEDIUM}ê°œ"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ğŸ“¦ Image:*\neclipse-temurin:21-alpine"
                      }
                    ]
                  },
                  {
                    "type": "divider"
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*ğŸ” Critical/High ì·¨ì•½ì  ìƒì„¸ (${TOTAL_CVES}ê°œ CVE):*"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "${VULN_LIST_ESCAPED}${FOOTER_ESCAPED}"
                    }
                  },
                  {
                    "type": "divider"
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "ğŸ”— GitHub Actions ìƒì„¸ ë³´ê¸°",
                          "emoji": true
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      }
                    ]
                  }
                ]
              }
            ]
          }
          EOF
          
          # Slack ì „ì†¡
          curl -X POST -H 'Content-type: application/json' \
            --data @slack-payload.json \
            $SLACK_WEBHOOK_URL

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-results.json
          retention-days: 30
